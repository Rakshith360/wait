 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Voice Calculator (Enhanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the microphone button pulse animation */
        .pulse {
            animation: pulse-animation 1.5s infinite;
        }
        @keyframes pulse-animation {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md mx-auto p-6 bg-gray-800 rounded-2xl shadow-2xl space-y-6">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-100">Pro Voice Calculator</h1>
            <p class="text-gray-400 mt-1">Speak your calculations naturally</p>
        </header>

        <!-- Display Screen -->
        <div class="bg-gray-900 p-4 rounded-xl text-right space-y-2 min-h-[120px] flex flex-col justify-end">
            <div id="expression" class="text-gray-400 text-2xl break-words h-16 overflow-y-auto"></div>
            <div id="result" class="text-white text-5xl font-bold break-words">0</div>
        </div>

        <!-- Status Message -->
        <div id="status" class="text-center text-lg text-yellow-400 h-8 flex items-center justify-center">
            Click the mic to start
        </div>

        <!-- Controls -->
        <div class="grid grid-cols-3 gap-4">
            <button id="mic-btn" class="col-span-1 bg-red-600 hover:bg-red-700 transition-all duration-300 text-white rounded-xl p-4 flex justify-center items-center focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
            </button>
            <div class="col-span-2 grid grid-cols-2 gap-4">
                 <button id="calculate-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold rounded-xl p-4 transition-colors duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed">
                     Calculate
                 </button>
                 <button id="clear-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-xl p-4 transition-colors duration-300">
                     Clear
                 </button>
            </div>
        </div>
        
        <!-- Copy Button -->
         <div class="flex">
             <button id="copy-btn" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl p-4 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                 <span>Copy Result</span>
             </button>
         </div>
    </div>

    <script type="module">
        // --- DOM Element References ---
        const micBtn = document.getElementById('mic-btn');
        const calculateBtn = document.getElementById('calculate-btn');
        const clearBtn = document.getElementById('clear-btn');
        const copyBtn = document.getElementById('copy-btn');
        const expressionDiv = document.getElementById('expression');
        const resultDiv = document.getElementById('result');
        const statusDiv = document.getElementById('status');

        // --- Speech Recognition Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'en-US';
            recognition.interimResults = true;
        } else {
            statusDiv.textContent = "Sorry, your browser doesn't support speech recognition.";
            micBtn.disabled = true;
        }
        
        // --- State Management ---
        let isListening = false;
        let finalTranscript = '';

        // --- ENHANCED SPEECH PROCESSING LOGIC ---

        /**
         * Converts a string of number words (e.g., "four lakh fifty thousand") into a numeric string.
         * @param {string} text The input string containing number words.
         * @returns {string} The resulting numeric string (e.g., "450000").
         */
        function textToNumber(text) {
            if (!text) return '';
            // If the input is already a valid number, just return it.
            if (!isNaN(text)) return text;
            
            const words = text.split(/\s+/).filter(Boolean);

            const numberMap = {
                'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5, 'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
                'eleven': 11, 'twelve': 12, 'thirteen': 13, 'fourteen': 14, 'fifteen': 15, 'sixteen': 16, 'seventeen': 17, 'eighteen': 18, 'nineteen': 19,
                'twenty': 20, 'thirty': 30, 'forty': 40, 'fifty': 50, 'sixty': 60, 'seventy': 70, 'eighty': 80, 'ninety': 90
            };
            
            const scaleMap = {
                'hundred': 100, 'thousand': 1000, 'lakh': 100000, 'million': 1000000, 'crore': 10000000, 'billion': 1000000000
            };

            let total = 0;
            let currentChunkValue = 0;

            for (let word of words) {
                // Handle plurals like 'lakhs', 'crores'
                word = word.replace(/s$/, '');

                if (numberMap[word] !== undefined) {
                    currentChunkValue += numberMap[word];
                } else if (word === 'hundred') {
                    currentChunkValue *= 100;
                } else if (scaleMap[word] !== undefined) {
                    // Handle cases like "a thousand", where currentChunkValue is 0
                    if (currentChunkValue === 0) currentChunkValue = 1; 
                    total += currentChunkValue * scaleMap[word];
                    currentChunkValue = 0;
                } else if (!isNaN(word)) {
                    currentChunkValue += parseFloat(word);
                } else {
                    console.warn(`Unrecognized number word: ${word}`);
                }
            }
            total += currentChunkValue;

            return total > 0 || text.includes('zero') || text.includes('0') ? String(total) : '';
        }

        /**
         * Processes a chunk of transcribed speech, converting it into a part of a mathematical expression.
         * @param {string} transcript The speech-to-text transcript chunk.
         * @returns {string} The processed string to be appended to the expression.
         */
        function processSpeech(transcript) {
            let text = transcript.toLowerCase().trim();

            // 1. Handle Commands first
            const commands = {
                'clear': () => clearAll(),
                'reset': () => clearAll(),
                'equals': () => calculateAndDisplay(),
                'equal': () => calculateAndDisplay(),
                'calculate': () => calculateAndDisplay(),
            };
            if (commands[text]) {
                commands[text]();
                return ''; // Command executed, so return empty string
            }

            // 2. Clean and standardize the text for parsing
            text = text.replace(/,/g, '') // Removes commas, fixing the "1,000" issue
                       .replace(/\band\b/g, ' ')
                       .replace(/multiplied by/g, 'multiply')
                       .replace(/divided by/g, 'divide')
                       .replace(/a hundred/g, 'one hundred')
                       .replace(/a thousand/g, 'one thousand')
                       .replace(/a lakh/g, 'one lakh')
                       .replace(/a crore/g, 'one crore');

            const words = text.split(/\s+/).filter(Boolean);
            let expressionPart = '';
            let numberParts = [];

            const operators = {
                'plus': '+', 'add': '+',
                'minus': '-', 'subtract': '-', 'less': '-',
                'times': '*', 'multiply': '*', 'x': '*',
                'divide': '/', 'over': '/',
                'point': '.', 'dot': '.'
            };

            // 3. Loop through words, separating numbers from operators
            for (const word of words) {
                if (operators[word]) {
                    // When an operator is found, process the preceding number words
                    if (numberParts.length > 0) {
                        expressionPart += textToNumber(numberParts.join(' '));
                        numberParts = [];
                    }
                    expressionPart += operators[word];
                } else {
                    // If not an operator, assume it's part of a number
                    numberParts.push(word);
                }
            }
            // Process any remaining number words at the end of the chunk
            if (numberParts.length > 0) {
                expressionPart += textToNumber(numberParts.join(' '));
            }
            
            return expressionPart;
        }

        // --- Core Functions ---
        function calculateAndDisplay() {
            if (expressionDiv.textContent === '') return;
            try {
                // Sanitize the expression to prevent malicious code injection
                const sanitizedExpression = expressionDiv.textContent.replace(/[^-()\d/*+.]/g, '');
                if (sanitizedExpression !== expressionDiv.textContent) {
                    throw new Error("Invalid characters in expression");
                }
                const result = new Function(`return ${sanitizedExpression}`)();

                if (isNaN(result) || !isFinite(result)) {
                   throw new Error("Invalid calculation");
                }
                
                // Format result to a reasonable number of decimal places
                resultDiv.textContent = Number(result.toFixed(10));
            } catch (error) {
                resultDiv.textContent = 'Error';
                console.error("Calculation Error:", error);
            }
        }
        
        function clearAll() {
            finalTranscript = '';
            expressionDiv.textContent = '';
            resultDiv.textContent = '0';
            statusDiv.textContent = 'Cleared. Click the mic to start again.';
        }

        // --- Event Handlers for Speech Recognition ---
        if (recognition) {
            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('pulse');
                statusDiv.textContent = 'Listening...';
                calculateBtn.disabled = true;
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('pulse');
                statusDiv.textContent = 'Mic off. Click to start again.';
                if (expressionDiv.textContent) {
                    calculateBtn.disabled = false;
                }
            };
            
            recognition.onerror = (event) => {
                console.error("Speech Recognition Error:", event.error);
                statusDiv.textContent = `Error: ${event.error}`;
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        // Use the new, more powerful processing function
                        const chunk = processSpeech(event.results[i][0].transcript);
                        if(chunk) {
                            finalTranscript += chunk;
                        }
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                expressionDiv.textContent = finalTranscript;
                expressionDiv.scrollTop = expressionDiv.scrollHeight; // Auto-scroll
                
                if (interimTranscript) {
                    statusDiv.textContent = `Thinking: ${interimTranscript}`;
                } else if(isListening) {
                    statusDiv.textContent = 'Listening...';
                }
            };
        }

        // --- Event Handlers for Buttons ---
        micBtn.addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            } else {
                if(recognition) recognition.start();
            }
        });

        clearBtn.addEventListener('click', clearAll);
        calculateBtn.addEventListener('click', calculateAndDisplay);

        copyBtn.addEventListener('click', () => {
            const textToCopy = resultDiv.textContent;
            
            // Use a temporary textarea to copy text, works well in most environments
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><polyline points="20 6 9 17 4 12"/></svg>
                    <span>Copied!</span>`;
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textArea);
        });

    </script>
</body>
</html>
